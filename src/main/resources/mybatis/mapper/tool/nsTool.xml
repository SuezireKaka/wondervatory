<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="www.wonder.vatory.tool.mapper.ToolMapper">
	<resultMap id="rmToolVO" extends="nsEntity.rmTimeEntity"
		type="www.wonder.vatory.tool.model.ToolVO">
		<result property="name" column="name" />
		<result property="xToolSize" column="x_tool_size" />
		<result property="yToolSize" column="y_tool_size" />
		<association property="parentSeries" columnPrefix="p_ser_"
				resultMap="www.wonder.vatory.work.mapper.WorkMapper.rmSeriesVO" />
		<association property="parentEntity" columnPrefix="p_ent_"
				resultMap="rmCustomEntityVO" />
	</resultMap>
	
	<resultMap id="rmCustomObjectVO" extends="nsEntity.rmSpaceEntity"
		type="www.wonder.vatory.tool.model.CustomObjectVO">
		<result property="name" column="name" />
		<collection property="customPropertiesList" columnPrefix="prop_"
			resultMap="rmCustomPropertyVO">
		</collection>
		<discriminator javaType="String" column="descrim">
         	<case value="Entity" resultMap="rmCustomEntityVO" />
         	<case value="Relation" resultMap="rmCustomRelationVO" />
        </discriminator>
	</resultMap>
	
	<resultMap id="rmCustomEntityVO" extends="rmCustomObjectVO"
		type="www.wonder.vatory.tool.model.CustomEntityVO">
		<association property="childTool" columnPrefix="c_tol_"
				resultMap="rmToolVO" />
	</resultMap>
	
	<resultMap id="rmCustomRelationVO" extends="rmCustomObjectVO"
		type="www.wonder.vatory.tool.model.CustomRelationVO">
		<association property="one" columnPrefix="one_" notNullColumn="id"
				resultMap="rmCustomEntityVO" />
		<association property="other" columnPrefix="other_" notNullColumn="id"
				resultMap="rmCustomEntityVO" />
	</resultMap>
	
	<resultMap id="rmCustomPropertyVO"
		type="www.wonder.vatory.tool.model.CustomPropertyVO">
		<result property="propType" column="prop_type" />
		<result property="propVal" column="prop_val" />
	</resultMap>
	
	<!-- public long getFoundRows(); -->
	<select id="getFoundRows" resultType="long">
		SELECT FOUND_ROWS()
	</select>

	<!--public List<ToolVO> listAllFromSeries(@Param("seriesId") String seriesId, @Param("paging") PagingDTO paging); -->
	<select id="listAllFromSeries" resultMap="rmToolVO">
		SELECT SQL_CALC_FOUND_ROWS *
		  FROM t_tool
		 where parent_id = #{seriesId}
		   and parent_type = 'Series'
	</select>
	
	<!-- public List<CustomEntityVO> listAllEntity(@Param("toolId") String toolId);  -->
	<select id="listAllEntity" resultMap="rmCustomEntityVO">
		SELECT *
		  from t_custom_obj
		 where parent_id = #{toolId}
		   and descrim = 'Entity'
	</select>
	
	<!-- public List<CustomObjectVO> listPropertiesOf(@Param("objectId") String objectId); -->
	<select id="listPropertiesOf" resultMap="rmCustomPropertyVO">
		SELECT prop.*
		  from t_custom_property prop
		 where prop.owner_id = #{objectId}
	</select>
	
	<!-- public int countPropertiesOf(@Param("objectId") String objectId); -->
	<select id="countPropertiesOf">
		SELECT count(*)
		  from t_custom_property
		 where owner_id = #{objectId}
	</select>
	
	<!-- public List<CustomRelationVO> listAllRelation(@Param("toolId") String toolId);-->
	<select id="listAllRelation" resultMap="rmCustomRelationVO">
		SELECT rel.*,
			one.x_pos one_x_pos, one.y_pos one_y_pos,
			one.x_size one_x_size, one.y_size one_y_size,
			other.x_pos other_x_pos, other.y_pos other_y_pos,
			other.x_size other_x_size, other.y_size other_y_size
		  from t_custom_obj rel, t_custom_obj one, t_custom_obj other
		 where rel.parent_id = #{toolId}
		   and one.id = rel.one_id
		   and other.id = rel.other_id
	</select>
	
	<!-- public ToolVO getToolById(@Param("toolId") String toolId); -->
	<select id="getToolById" resultMap="rmToolVO">
		SELECT *
		  from t_tool
		 where id = #{toolId}
	</select>
	
	<!-- public ToolVO getToolByEntity(@Param("entityId") String entityId); -->
	<select id="getToolByEntity" resultMap="rmToolVO">
		SELECT *
		  from t_tool
		 where parent_id = #{entityId}
		   and parent_type = 'Entity'
	</select>
	
	<!-- public int insertToSync(@Param("objectId") String objectId, @Param("offset") int offset,
			@Param("insertList") List<CustomPropertyDTO> insertList);-->
	<insert id="insertToSync">
		<if test="!(insertList.isEmpty())">
			INSERT INTO t_custom_property(owner_id, level, prop_type, prop_val)
			VALUES
			<foreach item="prop" collection="insertList" separator="," index="index" close=";">
				(#{objectId}, (#{index} + #{offset}), #{prop.propType}, #{prop.propVal})
			</foreach>
		</if>
	</insert>
	
	<!-- public int updateAllPropsFrom(@Param("objectId") String objectId,
			@Param("updateList") List<CustomPropertyDTO> updateList);-->
	<update id="updateAllPropsFrom">
		<if test="!(updateList.isEmpty())">
			UPDATE t_custom_property prop
			  JOIN (
			<foreach item="prop" collection="updateList" separator=" UNION ALL " index="index" close=")">
			<if test="prop.isEdited">
			  <choose>
			    <when test = "index == 0">
				  SELECT #{index} as LEVEL, #{prop.propType} as prop_type, #{prop.propVal} as prop_val
			    </when>
			    <otherwise>
				  SELECT #{index}, #{prop.propType}, #{prop.propVal}
			    </otherwise>
			  </choose>
			</if>
			</foreach> vals ON prop.level = vals.level
			   SET prop.prop_type = vals.prop_type, prop.prop_val = vals.prop_val
			 WHERE prop.owner_id = '0000'
		</if>
	</update>
	
	<!-- public int deleteToSync(@Param("objectId") String objectId,
			@Param("border") long border);-->
	<delete id="deleteToSync">
		DELETE prop.*
		  from t_custom_property prop
		 where prop.owner_id = #{objectId}
		   and prop.level >= ${border}
	</delete>

</mapper>
